generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH & MULTI-TENANCY
// ============================================

model Team {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users      User[]
  companies  Company[]
  contacts   Contact[]
  deals      Deal[]
  activities Activity[]
  invites    Invite[]

  @@map("teams")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  role          Role      @default(member)
  teamId        String
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  team               Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  sessions           Session[]
  ownedContacts      Contact[]          @relation("ContactOwner")
  ownedDeals         Deal[]             @relation("DealOwner")
  createdActivities  Activity[]         @relation("ActivityCreator")
  emailVerifications EmailVerification[]

  @@index([teamId])
  @@index([email])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@map("sessions")
}

model Invite {
  id        String       @id @default(cuid())
  email     String
  role      Role         @default(member)
  token     String       @unique
  teamId    String
  status    InviteStatus @default(pending)
  expiresAt DateTime
  createdAt DateTime     @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([teamId])
  @@index([teamId, email]) // Composite for checking existing invites
  @@map("invites")
}

model PasswordReset {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
  @@map("password_resets")
}

model EmailVerification {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  verifiedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("email_verifications")
}

enum Role {
  owner
  admin
  member
  viewer
}

enum InviteStatus {
  pending
  accepted
  expired
}

// ============================================
// CRM ENTITIES
// ============================================

model Company {
  id        String    @id @default(cuid())
  name      String
  domain    String?
  industry  String?
  teamId    String
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  team     Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  contacts Contact[]
  deals    Deal[]

  @@unique([teamId, name]) // Company names must be unique per team
  @@index([teamId])
  @@index([name])
  @@index([deletedAt])
  @@map("companies")
}

model Contact {
  id        String    @id @default(cuid())
  name      String
  email     String?
  phone     String?
  title     String?
  companyId String?
  ownerId   String
  teamId    String
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  team       Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  company    Company?   @relation(fields: [companyId], references: [id], onDelete: SetNull)
  owner      User       @relation("ContactOwner", fields: [ownerId], references: [id])
  deals      Deal[]
  activities Activity[]

  @@unique([teamId, email]) // Contact emails must be unique per team (NULL allowed)
  @@index([teamId])
  @@index([companyId])
  @@index([ownerId])
  @@index([name])
  @@index([email])
  @@index([deletedAt])
  @@map("contacts")
}

model Deal {
  id          String    @id @default(cuid())
  title       String
  value       Decimal?  @db.Decimal(12, 2)
  stage       DealStage @default(lead)
  probability Int?      @default(0)
  companyId   String?
  contactId   String?
  ownerId     String
  teamId      String
  closedAt    DateTime?
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  team       Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  company    Company?   @relation(fields: [companyId], references: [id], onDelete: SetNull)
  contact    Contact?   @relation(fields: [contactId], references: [id], onDelete: SetNull)
  owner      User       @relation("DealOwner", fields: [ownerId], references: [id])
  activities Activity[]

  @@index([teamId])
  @@index([companyId])
  @@index([contactId])
  @@index([ownerId])
  @@index([stage])
  @@index([teamId, stage]) // Composite for pipeline queries
  @@index([deletedAt])
  @@map("deals")
}

enum DealStage {
  lead
  qualified
  proposal
  negotiation
  won
  lost
}

model Activity {
  id          String        @id @default(cuid())
  type        ActivityType
  title       String
  description String?
  dueAt       DateTime?
  completedAt DateTime?
  dealId      String?
  contactId   String?
  userId      String
  teamId      String
  deletedAt   DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  team    Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  deal    Deal?    @relation(fields: [dealId], references: [id], onDelete: SetNull)
  contact Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  user    User     @relation("ActivityCreator", fields: [userId], references: [id])

  @@index([teamId])
  @@index([dealId])
  @@index([contactId])
  @@index([userId])
  @@index([dueAt])
  @@index([completedAt])
  @@index([teamId, dueAt]) // Composite for upcoming activities
  @@index([teamId, completedAt]) // Composite for overdue queries
  @@index([deletedAt])
  @@map("activities")
}

enum ActivityType {
  call
  email
  meeting
  task
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  teamId     String
  userId     String?  // Null for system actions
  action     String   // e.g., "contact.create", "deal.update", "user.login"
  entityType String?  // e.g., "contact", "deal", "user"
  entityId   String?  // ID of the affected entity
  metadata   Json?    // Additional context (old values, new values, etc.)
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([teamId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
