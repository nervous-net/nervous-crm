# Bug Hunt Report - December 15, 2025

## Summary

Conducted a comprehensive code review of the Nervous CRM application. Found 15 issues across backend services, frontend components, and database schema.

---

## Critical Issues

### 1. Missing Team Validation in Activity Service
**File:** `src/services/activity.service.ts:85-102`
**Severity:** High

When creating activities, the service doesn't validate that `dealId` and `contactId` belong to the team. This is inconsistent with `contact.service.ts` and `deal.service.ts` which properly validate cross-references using `validateTeamContact()` and `validateTeamCompany()`.

**Impact:** A user could potentially link activities to deals/contacts from other teams if they guess the IDs.

---

### 2. parseSort Crashes on Undefined Input
**File:** `src/lib/query-helpers.ts:16-26`
**Severity:** High

```typescript
export function parseSort(
  sort: string,  // Assumes string is always provided
  validFields: string[],
  defaultField: string = 'createdAt'
): SortResult {
  const desc = sort.startsWith('-');  // Crashes if sort is undefined
```

The function doesn't handle undefined input. While callers typically provide defaults via Zod schemas, edge cases could cause crashes.

**Fix:** Add `if (!sort) return { [defaultField]: 'desc' };` at the start.

---

### 3. Inconsistent Cookie Max Age Values
**File:** `src/api/auth/auth.routes.ts`
**Severity:** Medium

Register endpoint (line 67-73) uses constants:
```typescript
maxAge: COOKIE_MAX_AGE.ACCESS_TOKEN,  // From constants.ts
```

Login endpoint (line 118-125) uses hardcoded values:
```typescript
maxAge: 15 * 60,  // Hardcoded
```

**Impact:** If constants are updated, login cookies would have different lifetimes than register cookies.

---

## Medium Issues

### 4. No Debounce on Contacts Search
**File:** `web/src/pages/contacts/Contacts.tsx:36-39`
**Severity:** Medium

```typescript
const { data, isLoading } = useQuery({
  queryKey: ['contacts', search],
  queryFn: () => api.get<ContactsResponse>(`/contacts?search=${search}&limit=50`),
});
```

Search triggers API calls on every keystroke with no debounce. Rapid typing causes excessive API calls.

**Fix:** Add `useDeferredValue` or a debounce hook.

---

### 5. Frontend/Backend Validation Schema Mismatch
**File:** `web/src/pages/contacts/ContactNew.tsx:15-21`
**Severity:** Medium

Frontend schema:
```typescript
email: z.string().email('Invalid email').optional().or(z.literal('')),
```

Backend schema (`src/shared/schemas/contact.ts:5`):
```typescript
email: z.string().email().max(200).optional().nullable(),
```

Empty string `''` passes frontend validation but could cause issues with backend's `.email()` validator.

---

### 6. Missing Loading States for Dropdown Data
**Files:** `web/src/pages/contacts/ContactNew.tsx:35-38`, `web/src/pages/deals/DealNew.tsx:41-48`
**Severity:** Low

Company and contact dropdowns don't show loading indicators while data is being fetched. Users might submit forms before options are loaded.

---

### 7. Missing Audit Logging for Profile Updates
**File:** `src/api/users/users.routes.ts:72-85`
**Severity:** Medium

Profile updates (email/name changes) are not logged to the audit system, while login and password changes are. This creates gaps in audit trails.

---

### 8. Soft-Deleted Entities Still Referenced
**Files:** `src/services/deal.service.ts`, `src/services/activity.service.ts`
**Severity:** Low

When creating deals or activities, validation checks `deletedAt: null`. However, if a contact/company is soft-deleted AFTER being linked, the deal/activity still references the "deleted" entity. The app handles this gracefully (shows null), but could be confusing for users.

---

## Low Priority / Notes

### 9. Password Reset Token Exposed in Development
**File:** `src/api/auth/auth.routes.ts:263-264`
**Severity:** Low (by design)

The reset token is returned in API response when `NODE_ENV !== 'production'`. Documented behavior but verify production config is correct.

---

### 10. Contact Email Unique Constraint Allows Multiple NULLs
**File:** `prisma/schema.prisma:170`

```prisma
@@unique([teamId, email]) // Contact emails must be unique per team (NULL allowed)
```

PostgreSQL allows multiple NULL values in unique constraints, so multiple contacts can have NULL email. This is likely intentional but worth documenting.

---

### 11. Missing Return Statement (Cosmetic)
**File:** `web/src/routes.tsx:32-38`

```typescript
function withSuspense(Component: React.ComponentType) {
  return (
    <Suspense fallback={<PageLoader />}>
      <Component />
    </Suspense>
  );  // Works but implicit return
}
```

---

### 12. AuthContext Error Handling
**File:** `web/src/contexts/AuthContext.tsx:41-53`

`login` and `register` functions throw errors to callers but don't clean up state on failure. If `setUser` is called and a subsequent operation fails, state could be inconsistent.

---

### 13. Potential N+1 Query Pattern
**File:** `src/services/contact.service.ts:47`

```typescript
const total = await prisma.contact.count({ where });
```

Runs after `findMany`, creating two queries. Consider using `_count` in the main query for efficiency.

---

### 14. Missing Index for Common Query Pattern
**File:** `prisma/schema.prisma`

Queries commonly filter by `teamId` AND `deletedAt: null` together. A composite index `@@index([teamId, deletedAt])` could improve performance.

---

### 15. CSRF Token Caching Could Cause Issues
**File:** `web/src/lib/api.ts:9-34`

CSRF token is cached indefinitely. If the server rotates tokens (e.g., on session changes), cached tokens become invalid. The 403 handling clears the token, but first request will fail.

---

## Recommendations

1. **High Priority:** Fix activity service team validation
2. **High Priority:** Add null check to `parseSort`
3. **Medium Priority:** Standardize cookie max age using constants
4. **Medium Priority:** Add debounce to search inputs
5. **Low Priority:** Add audit logging for profile updates
6. **Low Priority:** Consider composite indexes for common queries

---

## Files Reviewed

- `src/server.ts`
- `src/lib/auth.ts`
- `src/lib/config.ts`
- `src/lib/constants.ts`
- `src/lib/jwt.ts`
- `src/lib/query-helpers.ts`
- `src/lib/validation.ts`
- `src/services/auth.service.ts`
- `src/services/contact.service.ts`
- `src/services/deal.service.ts`
- `src/services/company.service.ts`
- `src/services/activity.service.ts`
- `src/services/team.service.ts`
- `src/api/auth/auth.routes.ts`
- `src/api/contacts/contacts.routes.ts`
- `src/api/deals/deals.routes.ts`
- `src/api/users/users.routes.ts`
- `src/shared/schemas/*.ts`
- `prisma/schema.prisma`
- `web/src/lib/api.ts`
- `web/src/lib/utils.ts`
- `web/src/routes.tsx`
- `web/src/contexts/AuthContext.tsx`
- `web/src/layouts/DashboardLayout.tsx`
- `web/src/pages/contacts/Contacts.tsx`
- `web/src/pages/contacts/ContactNew.tsx`
- `web/src/pages/deals/Deals.tsx`
- `web/src/pages/deals/DealNew.tsx`
